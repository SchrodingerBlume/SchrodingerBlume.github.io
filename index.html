<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç‰©ååº”å™¨è®¾å¤‡å­¦ä¹ ç»ƒä¹ ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .nav-btn.active {
            background: #4CAF50;
            color: white;
            transform: scale(1.05);
        }
        
        .nav-btn:not(.active) {
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .nav-btn:hover:not(.active) {
            background: rgba(255,255,255,1);
            transform: scale(1.02);
        }
        
        .section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section.active {
            display: block;
        }
        
        .exam-config {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .config-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .config-row label {
            font-weight: bold;
            min-width: 120px;
        }
        
        .config-row input, .config-row select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .question-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .question-type {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options {
            margin-bottom: 20px;
        }
        
        .option {
            display: block;
            margin: 10px 0;
            padding: 10px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        
        .option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .option.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .option.wrong {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .fill-blank input {
            border: none;
            border-bottom: 2px solid #007bff;
            padding: 5px 10px;
            font-size: 16px;
            background: transparent;
            margin: 0 5px;
            min-width: 100px;
        }
        
        .fill-blank input.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .fill-blank input.wrong {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.wrong {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .add-question-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .option-inputs {
            display: none;
        }
        
        .option-inputs.show {
            display: block;
        }
        
        .option-input {
            margin-bottom: 10px;
        }
        
        .exam-progress {
            background: #e9ecef;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .exam-progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
        
        .similarity-score {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .stats {
                flex-direction: column;
                gap: 20px;
            }
            
            .config-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .config-row label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç”Ÿç‰©ååº”å™¨è®¾å¤‡å­¦ä¹ ç³»ç»Ÿ</h1>
            <p>åŸºäºè¯¾ç¨‹é‡ç‚¹å†…å®¹çš„æ™ºèƒ½ç»ƒä¹ å¹³å°</p>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('exam')">å¼€å§‹è€ƒè¯•</button>
            <button class="nav-btn" onclick="showSection('practice')">è‡ªç”±ç»ƒä¹ </button>
            <button class="nav-btn" onclick="showSection('manage')">é¢˜åº“ç®¡ç†</button>
            <button class="nav-btn" onclick="showSection('wrongbook')">é”™é¢˜æœ¬</button>
            <button class="nav-btn" onclick="showSection('bookmarks')">æˆ‘çš„ä¹¦ç­¾</button>
            <button class="nav-btn" onclick="showSection('stats')">å­¦ä¹ ç»Ÿè®¡</button>
        </div>
        
        <!-- è€ƒè¯•æ¨¡å— -->
        <div id="exam" class="section active">
            <h2>è€ƒè¯•æ¨¡å¼</h2>
            <div class="exam-config" id="examConfig">
                <div class="config-row">
                    <label>é¢˜ç›®æ•°é‡ï¼š</label>
                    <input type="number" id="examQuestionCount" value="10" min="1" max="50">
                    <span>é¢˜ï¼ˆæœ€å¤š50é¢˜ï¼‰</span>
                </div>
                <div class="config-row">
                    <label>é¢˜å‹é€‰æ‹©ï¼š</label>
                    <select id="examQuestionType">
                        <option value="all">å…¨éƒ¨é¢˜å‹</option>
                        <option value="fill">ä»…å¡«ç©ºé¢˜</option>
                        <option value="choice">ä»…é€‰æ‹©é¢˜</option>
                        <option value="essay">ä»…ç®€ç­”é¢˜</option>
                    </select>
                </div>
                <div class="buttons">
                    <button class="btn btn-success" onclick="startExam()">å¼€å§‹è€ƒè¯•</button>
                </div>
            </div>
            
            <div id="examContent" style="display: none;">
                <div class="exam-progress">
                    <div class="exam-progress-bar" id="examProgressBar"></div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="examCurrent">1</div>
                        <div>å½“å‰é¢˜ç›®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="examTotal">10</div>
                        <div>æ€»é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="examCorrect">0</div>
                        <div>å·²ç­”å¯¹</div>
                    </div>
                </div>
                
                <div id="examQuestionContainer">
                    <!-- è€ƒè¯•é¢˜ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="endExam()">ç»“æŸè€ƒè¯•</button>
                </div>
            </div>
            
            <div id="examResult" style="display: none;">
                <h2>è€ƒè¯•ç»“æœ</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="finalCorrect">0</div>
                        <div>ç­”å¯¹é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="finalTotal">0</div>
                        <div>æ€»é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="finalAccuracy">0%</div>
                        <div>æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="finalTime">0</div>
                        <div>ç”¨æ—¶(åˆ†é’Ÿ)</div>
                    </div>
                </div>
                
                <div id="examGrade" style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 2.5em; font-weight: bold; color: #007bff;" id="gradeDisplay">0åˆ†</div>
                    <div style="font-size: 1.2em; margin-top: 10px;" id="gradeComment">ç»§ç»­åŠªåŠ›ï¼</div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" onclick="resetExam()">é‡æ–°è€ƒè¯•</button>
                    <button class="btn btn-secondary" onclick="showWrongQuestions()" id="wrongQuestionsBtn" style="display: none;">æŸ¥çœ‹é”™é¢˜ (0)</button>
                </div>
                
                <div id="wrongQuestionsSection" style="display: none; margin-top: 20px;">
                    <h3>æœ¬æ¬¡è€ƒè¯•é”™é¢˜å›é¡¾</h3>
                    <div id="currentExamWrongQuestions"></div>
                </div>
            </div>
        </div>
        
        <!-- è‡ªç”±ç»ƒä¹ æ¨¡å— -->
        <div id="practice" class="section">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div>æ€»é¢˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="correctCount">0</div>
                    <div>ç­”å¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="wrongCount">0</div>
                    <div>ç­”é”™</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracy">0%</div>
                    <div>æ­£ç¡®ç‡</div>
                </div>
            </div>
            
            <div id="questionContainer">
                <!-- é¢˜ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- é”™é¢˜æœ¬æ¨¡å— -->
        <div id="wrongbook" class="section">
            <h2>é”™é¢˜æœ¬</h2>
            <div style="margin-bottom: 20px;">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="wrongQuestionsCount">0</div>
                        <div>é”™é¢˜æ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="wrongQuestionsRate">0%</div>
                        <div>é”™è¯¯ç‡</div>
                    </div>
                </div>
                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="practiceWrongQuestions()">ä¸“é¡¹ç»ƒä¹ </button>
                    <button class="btn btn-secondary" onclick="clearWrongQuestions()">æ¸…ç©ºé”™é¢˜æœ¬</button>
                </div>
            </div>
            <div id="wrongQuestionsContainer">
                <!-- é”™é¢˜å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <!-- æˆ‘çš„ä¹¦ç­¾æ¨¡å— -->
        <div id="bookmarks" class="section">
            <h2>æˆ‘çš„ä¹¦ç­¾</h2>
            <div style="margin-bottom: 20px;">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="bookmarksCount">0</div>
                        <div>æ”¶è—é¢˜æ•°</div>
                    </div>
                </div>
                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="practiceBookmarkedQuestions()">ä¸“é¡¹ç»ƒä¹ </button>
                    <button class="btn btn-secondary" onclick="clearBookmarks()">æ¸…ç©ºä¹¦ç­¾</button>
                </div>
            </div>
            <div id="bookmarksContainer">
                <!-- æ”¶è—çš„é¢˜ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <!-- é¢˜åº“ç®¡ç†æ¨¡å— -->
        <div id="manage" class="section">
            <h2>æ·»åŠ æ–°é¢˜ç›®</h2>
            <div class="add-question-form">
                <div class="form-group">
                    <label>é¢˜ç›®ç±»å‹ï¼š</label>
                    <select id="questionType" onchange="toggleOptions()">
                        <option value="fill">å¡«ç©ºé¢˜</option>
                        <option value="choice">é€‰æ‹©é¢˜</option>
                        <option value="essay">ç®€ç­”é¢˜</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>é¢˜ç›®å†…å®¹ï¼š</label>
                    <textarea id="questionText" placeholder="è¾“å…¥é¢˜ç›®å†…å®¹ï¼Œå¡«ç©ºé¢˜è¯·ç”¨ _____ è¡¨ç¤ºç©ºç™½å¤„"></textarea>
                </div>
                
                <div class="form-group">
                    <label>æ­£ç¡®ç­”æ¡ˆï¼š</label>
                    <textarea id="correctAnswer" placeholder="å¡«ç©ºé¢˜å¤šä¸ªç­”æ¡ˆè¯·ç”¨è‹±æ–‡åˆ†å·;åˆ†éš”ï¼Œç®€ç­”é¢˜å¯ä»¥è¾“å…¥å‚è€ƒç­”æ¡ˆ"></textarea>
                </div>
                
                <div id="optionInputs" class="option-inputs">
                    <div class="form-group">
                        <label>é€‰é¡¹Aï¼š</label>
                        <input type="text" id="optionA" placeholder="è¾“å…¥é€‰é¡¹A">
                    </div>
                    <div class="form-group">
                        <label>é€‰é¡¹Bï¼š</label>
                        <input type="text" id="optionB" placeholder="è¾“å…¥é€‰é¡¹B">
                    </div>
                    <div class="form-group">
                        <label>é€‰é¡¹Cï¼š</label>
                        <input type="text" id="optionC" placeholder="è¾“å…¥é€‰é¡¹C">
                    </div>
                    <div class="form-group">
                        <label>é€‰é¡¹Dï¼š</label>
                        <input type="text" id="optionD" placeholder="è¾“å…¥é€‰é¡¹D">
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-success" onclick="addQuestion()">æ·»åŠ é¢˜ç›®</button>
                    <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                </div>
            </div>
            
            <h2>é¢˜åº“é¢„è§ˆ</h2>
            <div id="questionBank">
                <!-- é¢˜åº“å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ¨¡å— -->
        <div id="stats" class="section">
            <h2>å­¦ä¹ ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalExams">0</div>
                    <div>è€ƒè¯•æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="avgAccuracy">0%</div>
                    <div>å¹³å‡æ­£ç¡®ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="bestStreak">0</div>
                    <div>æœ€é•¿è¿å¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="studyTime">0</div>
                    <div>å­¦ä¹ æ—¶é•¿(åˆ†)</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="clearStats()" style="background: #dc3545; border-color: #dc3545;">
                    æ¸…é›¶æ‰€æœ‰å­¦ä¹ ç»Ÿè®¡
                </button>
            </div>
        </div>
    </div>

    <script>
        // å†…ç½®é¢˜åº“ - åŸºäºæ‰€æœ‰slideå†…å®¹
        let builtInQuestionBank = [
            // ===== é‡ç‚¹åè¯è§£é‡Šç³»åˆ— (å¡«ç©ºé¢˜) =====
            {
                type: 'fill',
                question: '_____ æ˜¯æŒ‡æµä½“çš„å‰ªåˆ‡åº”åŠ›å’Œé€Ÿåº¦æ¢¯åº¦é—´çš„å…³ç³»ä¸éšå—å‰ªåˆ‡çš„æ—¶é—´è€Œå˜åŒ–çš„æµä½“ã€‚',
                answer: 'ç‰›é¡¿æµä½“',
                category: 'åè¯è§£é‡Š'
            },
            {
                type: 'fill',
                question: '_____ æ˜¯æŒ‡åœ¨ä¸€å®šè½¬é€Ÿä¸‹å†å¢åŠ ç½å†…é™„ä»¶è€Œè½´åŠŸç‡ä»ä¿æŒä¸å˜çš„æ¡ä»¶ã€‚',
                answer: 'å…¨æŒ¡æ¿æ¡ä»¶',
                category: 'åè¯è§£é‡Š'
            },
            // ===== ç”Ÿç‰©ååº”å™¨åˆ†ç±»ä¸è®¾è®¡ (é€‰æ‹©é¢˜) =====
            {
                type: 'choice',
                question: 'ç”Ÿç‰©ååº”å™¨æŒ‰ä»£è°¢è¦æ±‚å¯åˆ†ä¸ºï¼š',
                options: [
                    'A. æœºæ¢°æ…æ‹Œå¼å’Œæ°”å‡å¼',
                    'B. åŒæ°§ç”Ÿç‰©ååº”å™¨å’Œé€šæ°”ç”Ÿç‰©ååº”å™¨',
                    'C. é—´æ­‡å¼å’Œè¿ç»­å¼',
                    'D. å›ºå®šåŒ–å’Œæ‚¬æµ®å¼'
                ],
                answer: 'B',
                category: 'ååº”å™¨åˆ†ç±»'
            },
            {
                type: 'choice',
                question: 'æŒ‰æ‰€ç”¨çš„ç”Ÿç‰©å‚¬åŒ–å‰‚çš„ä¸åŒï¼Œç”Ÿç‰©ååº”å™¨å¯åˆ†ä¸ºï¼š',
                options: [
                    'A. åŒæ°§ååº”å™¨å’Œå¥½æ°§ååº”å™¨',
                    'B. é…¶å‚¬åŒ–ååº”å™¨å’Œç»†èƒç”Ÿç‰©ååº”å™¨',
                    'C. è¿ç»­å¼å’Œé—´æ­‡å¼',
                    'D. æ…æ‹Œå¼å’Œæ°”å‡å¼'
                ],
                answer: 'B',
                category: 'ååº”å™¨åˆ†ç±»'
            },
            // ===== ç®€ç­”é¢˜ç¤ºä¾‹ =====
            {
                type: 'essay',
                question: 'è¯·ç®€è¿°ç”Ÿç‰©ååº”å™¨è®¾è®¡çš„åŸºæœ¬åŸåˆ™å’Œä¸»è¦è€ƒè™‘å› ç´ ã€‚',
                answer: 'ç”Ÿç‰©ååº”å™¨è®¾è®¡åº”éµå¾ªä»¥ä¸‹åŸºæœ¬åŸåˆ™ï¼š1ï¼‰ä¸ºå¾®ç”Ÿç‰©æˆ–ç»†èƒæä¾›é€‚å®œçš„ç”Ÿé•¿å’Œä»£è°¢ç¯å¢ƒï¼›2ï¼‰å…·å¤‡è‰¯å¥½çš„ä¼ è´¨ä¼ çƒ­æ€§èƒ½ï¼›3ï¼‰ä¾¿äºæ— èŒæ“ä½œå’Œåœ¨çº¿ç›‘æ§ï¼›4ï¼‰ç»“æ„åˆç†ã€æ“ä½œç¨³å®šã€æ˜“äºæ”¾å¤§ï¼›5ï¼‰ç»æµåˆç†ã€ç»´æŠ¤æ–¹ä¾¿ã€‚ä¸»è¦è€ƒè™‘å› ç´ åŒ…æ‹¬ï¼šååº”å™¨ç±»å‹é€‰æ‹©ã€å‡ ä½•å°ºå¯¸ç¡®å®šã€æ…æ‹Œå’Œé€šæ°”ç³»ç»Ÿè®¾è®¡ã€ä¼ çƒ­ç³»ç»Ÿé…ç½®ã€æ£€æµ‹æ§åˆ¶ç³»ç»Ÿé›†æˆç­‰ã€‚',
                category: 'è®¾è®¡åŸç†'
            },
            {
                type: 'essay',
                question: 'æ¯”è¾ƒåˆ†ææ…æ‹Œå¼ç”Ÿç‰©ååº”å™¨å’Œæ°”å‡å¼ç”Ÿç‰©ååº”å™¨çš„ç‰¹ç‚¹åŠé€‚ç”¨èŒƒå›´ã€‚',
                answer: 'æ…æ‹Œå¼ç”Ÿç‰©ååº”å™¨ç‰¹ç‚¹ï¼šæ··åˆæ•ˆæœå¥½ï¼Œä¼ è´¨ä¼ çƒ­æ•ˆç‡é«˜ï¼Œé€‚åº”æ€§å¼ºï¼Œä½†å‰ªåˆ‡åŠ›å¤§ï¼Œèƒ½è€—é«˜ã€‚é€‚ç”¨äºç»†èŒã€é…µæ¯ç­‰å¯¹å‰ªåˆ‡åŠ›ä¸æ•æ„Ÿçš„å¾®ç”Ÿç‰©åŸ¹å…»ã€‚æ°”å‡å¼ç”Ÿç‰©ååº”å™¨ç‰¹ç‚¹ï¼šå‰ªåˆ‡åŠ›å°ï¼Œç»“æ„ç®€å•ï¼Œèƒ½è€—ä½ï¼Œä½†æ··åˆæ•ˆæœç›¸å¯¹è¾ƒå·®ã€‚é€‚ç”¨äºåŠ¨ç‰©ç»†èƒã€æ¤ç‰©ç»†èƒç­‰å¯¹å‰ªåˆ‡åŠ›æ•æ„Ÿçš„åŸ¹å…»å¯¹è±¡ã€‚é€‰æ‹©æ—¶éœ€è¦æ ¹æ®åŸ¹å…»å¯¹è±¡çš„ç”Ÿç†ç‰¹æ€§ã€å·¥è‰ºè¦æ±‚å’Œç»æµæ€§ç­‰å› ç´ ç»¼åˆè€ƒè™‘ã€‚',
                category: 'è®¾å¤‡æ¯”è¾ƒ'
            }
        ];
        
        // ç”¨æˆ·è‡ªå®šä¹‰é¢˜åº“
        let customQuestionBank = [];
        
        // é”™é¢˜å’Œä¹¦ç­¾
        let wrongQuestions = [];
        let bookmarkedQuestions = [];
        
        // è·å–å®Œæ•´é¢˜åº“
        function getFullQuestionBank() {
            return [...builtInQuestionBank, ...customQuestionBank];
        }

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            totalExams: 0,
            totalCorrectAnswers: 0,
            totalQuestions: 0,
            currentStreak: 0,
            bestStreak: 0,
            studyStartTime: Date.now(),
            practiceStats: {
                totalAnswered: 0,
                correctAnswers: 0
            }
        };

        // è€ƒè¯•ç›¸å…³å˜é‡
        let currentExam = {
            questions: [],
            currentIndex: 0,
            correctCount: 0,
            startTime: null,
            isActive: false,
            answers: [], // è®°å½•æ¯é“é¢˜çš„ç­”é¢˜æƒ…å†µ
            wrongQuestionIndexes: [] // è®°å½•ç­”é”™é¢˜ç›®çš„ç´¢å¼•
        };

        // è‡ªç”±ç»ƒä¹ ç›¸å…³å˜é‡
        let currentQuestion = null;
        let practiceAnswered = false;

        // åˆå§‹åŒ–
        function init() {
            loadStoredData();
            updateStats();
            updateQuestionBank();
            loadPracticeQuestion();
        }

        // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }

        // å¼€å§‹è€ƒè¯•
        function startExam() {
            const questionCount = parseInt(document.getElementById('examQuestionCount').value);
            const questionType = document.getElementById('examQuestionType').value;
            const fullBank = getFullQuestionBank();
            
            if (fullBank.length === 0) {
                alert('é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ é¢˜ç›®');
                return;
            }
            
            // è¿‡æ»¤é¢˜ç›®ç±»å‹
            let availableQuestions = fullBank;
            if (questionType !== 'all') {
                availableQuestions = fullBank.filter(q => q.type === questionType);
            }
            
            if (availableQuestions.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°è¯¥ç±»å‹çš„é¢˜ç›®');
                return;
            }
            
            // éšæœºé€‰æ‹©é¢˜ç›®
            const selectedQuestions = [];
            const actualCount = Math.min(questionCount, availableQuestions.length);
            
            for (let i = 0; i < actualCount; i++) {
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                selectedQuestions.push(availableQuestions.splice(randomIndex, 1)[0]);
            }
            
            currentExam = {
                questions: selectedQuestions,
                currentIndex: 0,
                correctCount: 0,
                startTime: Date.now(),
                isActive: true
            };
            
            document.getElementById('examConfig').style.display = 'none';
            document.getElementById('examContent').style.display = 'block';
            document.getElementById('examTotal').textContent = actualCount;
            
            loadExamQuestion();
        }

        // åŠ è½½è€ƒè¯•é¢˜ç›®
        function loadExamQuestion() {
            if (currentExam.currentIndex >= currentExam.questions.length) {
                finishExam();
                return;
            }
            
            const question = currentExam.questions[currentExam.currentIndex];
            const progress = ((currentExam.currentIndex + 1) / currentExam.questions.length) * 100;
            
            document.getElementById('examProgressBar').style.width = progress + '%';
            document.getElementById('examCurrent').textContent = currentExam.currentIndex + 1;
            document.getElementById('examCorrect').textContent = currentExam.correctCount;
            
            renderExamQuestion(question);
        }

        // æ¸²æŸ“è€ƒè¯•é¢˜ç›®
        function renderExamQuestion(question) {
            const container = document.getElementById('examQuestionContainer');
            
            if (question.type === 'fill') {
                const blanks = (question.question.match(/_____/g) || []).length;
                let questionHtml = question.question;
                for (let i = 0; i < blanks; i++) {
                    questionHtml = questionHtml.replace('_____', `<input type="text" class="answer-input" data-index="${i}">`);
                }
                
                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">å¡«ç©ºé¢˜</span>
                        <div class="question-text fill-blank">${questionHtml}</div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="submitExamFillAnswer()">æäº¤ç­”æ¡ˆ</button>
                            <button class="btn btn-warning" onclick="markAsCorrect()">æ­¤é¢˜ç­”å¯¹äº†</button>
                        </div>
                        <div id="examResult"></div>
                    </div>
                `;
            } else if (question.type === 'choice') {
                const optionsHtml = question.options.map((option, index) => 
                    `<label class="option" onclick="selectExamOption(this, '${option.charAt(0)}')">
                        <input type="radio" name="examChoice" value="${option.charAt(0)}" style="display:none;">
                        ${option}
                    </label>`
                ).join('');

                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">é€‰æ‹©é¢˜</span>
                        <div class="question-text">${question.question}</div>
                        <div class="options">${optionsHtml}</div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="submitExamChoiceAnswer()">æäº¤ç­”æ¡ˆ</button>
                            <button class="btn btn-warning" onclick="markAsCorrect()">æ­¤é¢˜ç­”å¯¹äº†</button>
                        </div>
                        <div id="examResult"></div>
                    </div>
                `;
            } else if (question.type === 'essay') {
                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">ç®€ç­”é¢˜</span>
                        <div class="question-text">${question.question}</div>
                        <div class="form-group">
                            <label>ä½ çš„ç­”æ¡ˆï¼š</label>
                            <textarea id="essayAnswer" rows="6" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                        </div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="submitEssayAnswer()">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</button>
                            <button class="btn btn-success" onclick="markEssayCorrect()">ç­”å¯¹äº†</button>
                            <button class="btn btn-secondary" onclick="markEssayWrong()">ç­”é”™äº†</button>
                        </div>
                        <div id="examResult"></div>
                    </div>
                `;
            }
        }

        // é€‰æ‹©è€ƒè¯•é€‰é¡¹
        function selectExamOption(element, value) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // æäº¤è€ƒè¯•å¡«ç©ºé¢˜ç­”æ¡ˆ
        function submitExamFillAnswer() {
            const question = currentExam.questions[currentExam.currentIndex];
            const inputs = document.querySelectorAll('.answer-input');
            const userAnswers = Array.from(inputs).map(input => input.value.trim());
            const correctAnswers = question.answer.split(';').map(ans => ans.trim());
            
            let isCorrect = true;
            if (userAnswers.length !== correctAnswers.length) {
                isCorrect = false;
            } else {
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i].toLowerCase() !== correctAnswers[i].toLowerCase()) {
                        isCorrect = false;
                        break;
                    }
                }
            }
            
            // æ ‡è®°è¾“å…¥æ¡†
            inputs.forEach((input, index) => {
                if (index < correctAnswers.length) {
                    const userAns = input.value.trim().toLowerCase();
                    const correctAns = correctAnswers[index].toLowerCase();
                    input.classList.add(userAns === correctAns ? 'correct' : 'wrong');
                }
            });
            
            // è®°å½•ç­”é¢˜æƒ…å†µ
            recordExamAnswer(question, userAnswers.join(';'), isCorrect);
            
            showExamResult(isCorrect, `æ­£ç¡®ç­”æ¡ˆï¼š${correctAnswers.join(' ; ')}`);
            if (isCorrect) {
                currentExam.correctCount++;
            }
        }

        // æäº¤è€ƒè¯•é€‰æ‹©é¢˜ç­”æ¡ˆ
        function submitExamChoiceAnswer() {
            const question = currentExam.questions[currentExam.currentIndex];
            const selectedOption = document.querySelector('input[name="examChoice"]:checked');
            if (!selectedOption) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                return;
            }
            
            const userAnswer = selectedOption.value;
            const isCorrect = userAnswer === question.answer;
            
            // æ ‡è®°æ‰€æœ‰é€‰é¡¹
            document.querySelectorAll('.option').forEach(option => {
                const optionValue = option.querySelector('input').value;
                if (optionValue === question.answer) {
                    option.classList.add('correct');
                } else if (optionValue === userAnswer && !isCorrect) {
                    option.classList.add('wrong');
                }
            });
            
            // è®°å½•ç­”é¢˜æƒ…å†µ
            recordExamAnswer(question, userAnswer, isCorrect);
            
            showExamResult(isCorrect, `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${question.answer}`);
            if (isCorrect) {
                currentExam.correctCount++;
            }
        }

        // è®°å½•è€ƒè¯•ç­”é¢˜æƒ…å†µ
        function recordExamAnswer(question, userAnswer, isCorrect) {
            const answerRecord = {
                question: question,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                timestamp: new Date().toLocaleString()
            };
            
            currentExam.answers.push(answerRecord);
            
            if (!isCorrect) {
                currentExam.wrongQuestionIndexes.push(currentExam.currentIndex);
                // æ·»åŠ åˆ°é”™é¢˜æœ¬ï¼ˆé¿å…é‡å¤ï¼‰
                const existingWrong = wrongQuestions.find(wq => 
                    wq.question.question === question.question && wq.question.type === question.type
                );
                if (!existingWrong) {
                    wrongQuestions.push(answerRecord);
                }
            }
        }

        // æäº¤ç®€ç­”é¢˜ç­”æ¡ˆ
        function submitEssayAnswer() {
            const question = currentExam.questions[currentExam.currentIndex];
            const userAnswer = document.getElementById('essayAnswer').value.trim();
            
            if (!userAnswer) {
                alert('è¯·å…ˆè¾“å…¥ä½ çš„ç­”æ¡ˆ');
                return;
            }
            
            // è®¡ç®—ç›¸ä¼¼åº¦
            const similarity = calculateSimilarity(userAnswer, question.answer);
            
            const resultHtml = `
                <div class="result info">
                    <h4>å‚è€ƒç­”æ¡ˆï¼š</h4>
                    <p>${question.answer}</p>
                    <div class="similarity-score">
                        <strong>ä¸å‚è€ƒç­”æ¡ˆç›¸ä¼¼åº¦ï¼š${similarity.toFixed(1)}%</strong>
                        <br><small>ç›¸ä¼¼åº¦è¶Šé«˜è¯´æ˜ç­”æ¡ˆè¶Šæ¥è¿‘å‚è€ƒç­”æ¡ˆ</small>
                    </div>
                    <p style="margin-top: 10px;"><strong>è¯·æ ¹æ®å‚è€ƒç­”æ¡ˆè‡ªè¡Œåˆ¤æ–­ä½ çš„å›ç­”æ˜¯å¦æ­£ç¡®</strong></p>
                </div>
            `;
            
            document.getElementById('examResult').innerHTML = resultHtml;
        }

        // è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦
        function calculateSimilarity(text1, text2) {
            const words1 = text1.replace(/[^\u4e00-\u9fa5\w]/g, '').split('');
            const words2 = text2.replace(/[^\u4e00-\u9fa5\w]/g, '').split('');
            
            const commonChars = words1.filter(char => words2.includes(char));
            const totalChars = Math.max(words1.length, words2.length);
            
            return totalChars > 0 ? (commonChars.length / totalChars) * 100 : 0;
        }

        // æ ‡è®°ç®€ç­”é¢˜æ­£ç¡®
        function markEssayCorrect() {
            currentExam.correctCount++;
            showExamResult(true, 'å·²æ ‡è®°ä¸ºæ­£ç¡®ç­”æ¡ˆ');
            setTimeout(() => {
                nextExamQuestion();
            }, 1500);
        }

        // æ ‡è®°ç®€ç­”é¢˜é”™è¯¯
        function markEssayWrong() {
            showExamResult(false, 'å·²æ ‡è®°ä¸ºé”™è¯¯ç­”æ¡ˆ');
            setTimeout(() => {
                nextExamQuestion();
            }, 1500);
        }

        // æ˜¾ç¤ºè€ƒè¯•ç»“æœ
        function showExamResult(isCorrect, message) {
            const resultDiv = document.getElementById('examResult');
            resultDiv.className = `result ${isCorrect ? 'correct' : 'wrong'}`;
            resultDiv.innerHTML = isCorrect ? 
                'âœ… å›ç­”æ­£ç¡®ï¼' : 
                `âŒ å›ç­”é”™è¯¯ï¼<br>${message}`;
            
            // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
            setTimeout(() => {
                nextExamQuestion();
            }, 2000);
        }

        // æ‰‹åŠ¨æ ‡è®°ä¸ºæ­£ç¡®
        function markAsCorrect() {
            currentExam.correctCount++;
            showExamResult(true, 'å·²æ‰‹åŠ¨æ ‡è®°ä¸ºæ­£ç¡®');
        }

        // ä¸‹ä¸€é“è€ƒè¯•é¢˜ç›®
        function nextExamQuestion() {
            currentExam.currentIndex++;
            loadExamQuestion();
        }

        // å®Œæˆè€ƒè¯•
        function finishExam() {
            const endTime = Date.now();
            const duration = Math.round((endTime - currentExam.startTime) / 60000);
            const accuracy = Math.round((currentExam.correctCount / currentExam.questions.length) * 100);
            const grade = Math.round(accuracy); // ç™¾åˆ†åˆ¶æˆç»©
            
            // æ›´æ–°è€ƒè¯•ç»Ÿè®¡
            stats.totalExams++;
            stats.totalCorrectAnswers += currentExam.correctCount;
            stats.totalQuestions += currentExam.questions.length;
            
            document.getElementById('examContent').style.display = 'none';
            document.getElementById('examResult').style.display = 'block';
            
            // æ˜¾ç¤ºè¯¦ç»†æˆç»©
            document.getElementById('finalCorrect').textContent = currentExam.correctCount;
            document.getElementById('finalTotal').textContent = currentExam.questions.length;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            document.getElementById('finalTime').textContent = duration;
            document.getElementById('gradeDisplay').textContent = grade + 'åˆ†';
            
            // æˆç»©è¯„ä»·
            let comment = '';
            let gradeColor = '';
            if (grade >= 90) {
                comment = 'ä¼˜ç§€ï¼ç»§ç»­ä¿æŒï¼';
                gradeColor = '#4CAF50';
            } else if (grade >= 80) {
                comment = 'è‰¯å¥½ï¼è¿˜æœ‰è¿›æ­¥ç©ºé—´ï¼';
                gradeColor = '#2196F3';
            } else if (grade >= 70) {
                comment = 'ä¸­ç­‰ï¼éœ€è¦åŠ å¼ºç»ƒä¹ ï¼';
                gradeColor = '#FF9800';
            } else if (grade >= 60) {
                comment = 'åŠæ ¼ï¼å»ºè®®é‡ç‚¹å¤ä¹ ï¼';
                gradeColor = '#FF5722';
            } else {
                comment = 'éœ€è¦åŠªåŠ›ï¼å»ºè®®ç³»ç»Ÿå¤ä¹ ï¼';
                gradeColor = '#f44336';
            }
            
            document.getElementById('gradeComment').textContent = comment;
            document.getElementById('gradeDisplay').style.color = gradeColor;
            
            // æ˜¾ç¤ºé”™é¢˜æŒ‰é’®
            const wrongCount = currentExam.wrongQuestionIndexes.length;
            if (wrongCount > 0) {
                const wrongBtn = document.getElementById('wrongQuestionsBtn');
                wrongBtn.style.display = 'inline-block';
                wrongBtn.textContent = `æŸ¥çœ‹é”™é¢˜ (${wrongCount})`;
            }
            
            currentExam.isActive = false;
            saveWrongQuestions();
            saveStats();
            updateStats();
            updateWrongQuestionsDisplay();
        }

        // ç»“æŸè€ƒè¯•
        function endExam() {
            if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰è€ƒè¯•å—ï¼Ÿ')) {
                finishExam();
            }
        }

        // é‡ç½®è€ƒè¯•
        function resetExam() {
            document.getElementById('examResult').style.display = 'none';
            document.getElementById('examConfig').style.display = 'block';
            document.getElementById('wrongQuestionsSection').style.display = 'none';
            currentExam = {
                questions: [],
                currentIndex: 0,
                correctCount: 0,
                startTime: null,
                isActive: false,
                answers: [],
                wrongQuestionIndexes: []
            };
        }

        // æ˜¾ç¤ºæœ¬æ¬¡è€ƒè¯•é”™é¢˜
        function showWrongQuestions() {
            const section = document.getElementById('wrongQuestionsSection');
            const container = document.getElementById('currentExamWrongQuestions');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                
                const wrongQuestions = currentExam.wrongQuestionIndexes.map(index => ({
                    question: currentExam.questions[index],
                    answer: currentExam.answers[index]
                }));
                
                container.innerHTML = wrongQuestions.map((item, index) => {
                    return renderQuestionCard(item.question, index, item.answer.userAnswer, false, true);
                }).join('');
                
                document.getElementById('wrongQuestionsBtn').textContent = 'éšè—é”™é¢˜';
            } else {
                section.style.display = 'none';
                document.getElementById('wrongQuestionsBtn').textContent = `æŸ¥çœ‹é”™é¢˜ (${currentExam.wrongQuestionIndexes.length})`;
            }
        }

        // æ¸²æŸ“é¢˜ç›®å¡ç‰‡ï¼ˆé€šç”¨å‡½æ•°ï¼‰
        function renderQuestionCard(question, index, userAnswer = '', showBookmarkBtn = false, showUserAnswer = false) {
            const questionTypeText = question.type === 'fill' ? 'å¡«ç©ºé¢˜' : 
                                   question.type === 'choice' ? 'é€‰æ‹©é¢˜' : 'ç®€ç­”é¢˜';
            
            let userAnswerHtml = '';
            if (showUserAnswer && userAnswer) {
                userAnswerHtml = `
                    <div style="margin-top: 15px; padding: 10px; background: #ffebee; border-radius: 5px;">
                        <strong>ä½ çš„ç­”æ¡ˆï¼š</strong>${userAnswer}
                    </div>
                `;
            }
            
            let optionsHtml = '';
            if (question.options) {
                optionsHtml = `
                    <div style="margin-top: 10px;">
                        <strong>é€‰é¡¹ï¼š</strong><br>
                        ${question.options.join('<br>')}
                    </div>
                `;
            }
            
            let bookmarkBtnHtml = '';
            if (showBookmarkBtn) {
                const isBookmarked = bookmarkedQuestions.some(bq => 
                    bq.question === question.question && bq.type === question.type
                );
                bookmarkBtnHtml = `
                    <button class="btn ${isBookmarked ? 'btn-warning' : 'btn-secondary'}" 
                            onclick="toggleBookmark(${index}, '${question.type}')">
                        ${isBookmarked ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—é¢˜ç›®'}
                    </button>
                `;
            }
            
            return `
                <div class="question-card">
                    <span class="question-type">${questionTypeText}</span>
                    <div class="question-text">${question.question}</div>
                    ${optionsHtml}
                    ${userAnswerHtml}
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${question.answer}
                    </div>
                    <div style="margin-top: 10px;">
                        ${bookmarkBtnHtml}
                    </div>
                </div>
            `;
        }

        // æ›´æ–°é”™é¢˜æœ¬æ˜¾ç¤º
        function updateWrongQuestionsDisplay() {
            const container = document.getElementById('wrongQuestionsContainer');
            const count = document.getElementById('wrongQuestionsCount');
            const rate = document.getElementById('wrongQuestionsRate');
            
            count.textContent = wrongQuestions.length;
            
            const totalAnswered = stats.practiceStats.totalAnswered + stats.totalQuestions;
            const wrongRate = totalAnswered > 0 ? Math.round((wrongQuestions.length / totalAnswered) * 100) : 0;
            rate.textContent = wrongRate + '%';
            
            if (wrongQuestions.length === 0) {
                container.innerHTML = '<p>æš‚æ— é”™é¢˜ï¼Œç»§ç»­åŠªåŠ›ï¼</p>';
                return;
            }
            
            container.innerHTML = wrongQuestions.map((item, index) => {
                return renderQuestionCard(item.question, index, item.userAnswer, true, true);
            }).join('');
        }

        // æ›´æ–°ä¹¦ç­¾æ˜¾ç¤º
        function updateBookmarksDisplay() {
            const container = document.getElementById('bookmarksContainer');
            const count = document.getElementById('bookmarksCount');
            
            count.textContent = bookmarkedQuestions.length;
            
            if (bookmarkedQuestions.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ”¶è—é¢˜ç›®</p>';
                return;
            }
            
            container.innerHTML = bookmarkedQuestions.map((question, index) => {
                return renderQuestionCard(question, index, '', true, false);
            }).join('');
        }

        // åˆ‡æ¢ä¹¦ç­¾çŠ¶æ€
        function toggleBookmark(index, type) {
            let question;
            if (type === 'wrong') {
                question = wrongQuestions[index].question;
            } else {
                question = wrongQuestions[index].question; // ä¸´æ—¶å¤„ç†ï¼Œå®é™…éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè°ƒæ•´
            }
            
            const existingIndex = bookmarkedQuestions.findIndex(bq => 
                bq.question === question.question && bq.type === question.type
            );
            
            if (existingIndex >= 0) {
                bookmarkedQuestions.splice(existingIndex, 1);
            } else {
                bookmarkedQuestions.push(question);
            }
            
            saveBookmarks();
            updateBookmarksDisplay();
            updateWrongQuestionsDisplay();
        }

        // ä¸“é¡¹ç»ƒä¹ é”™é¢˜
        function practiceWrongQuestions() {
            if (wrongQuestions.length === 0) {
                alert('é”™é¢˜æœ¬ä¸ºç©º');
                return;
            }
            
            showSection('practice');
            // è¿™é‡Œå¯ä»¥å®ç°ä¸“é—¨çš„é”™é¢˜ç»ƒä¹ é€»è¾‘
            alert('é”™é¢˜ä¸“é¡¹ç»ƒä¹ åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // ä¸“é¡¹ç»ƒä¹ ä¹¦ç­¾é¢˜ç›®
        function practiceBookmarkedQuestions() {
            if (bookmarkedQuestions.length === 0) {
                alert('ä¹¦ç­¾ä¸ºç©º');
                return;
            }
            
            showSection('practice');
            alert('ä¹¦ç­¾ä¸“é¡¹ç»ƒä¹ åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // æ¸…ç©ºé”™é¢˜æœ¬
        function clearWrongQuestions() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿ')) {
                wrongQuestions = [];
                saveWrongQuestions();
                updateWrongQuestionsDisplay();
                alert('é”™é¢˜æœ¬å·²æ¸…ç©º');
            }
        }

        // æ¸…ç©ºä¹¦ç­¾
        function clearBookmarks() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¹¦ç­¾å—ï¼Ÿ')) {
                bookmarkedQuestions = [];
                saveBookmarks();
                updateBookmarksDisplay();
                alert('ä¹¦ç­¾å·²æ¸…ç©º');
            }
        }

        // ä¿å­˜é”™é¢˜
        function saveWrongQuestions() {
            localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
        }

        // ä¿å­˜ä¹¦ç­¾
        function saveBookmarks() {
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarkedQuestions));
        }

        // è‡ªç”±ç»ƒä¹ ç›¸å…³å‡½æ•°
        function loadPracticeQuestion() {
            const fullBank = getFullQuestionBank();
            if (fullBank.length === 0) {
                document.getElementById('questionContainer').innerHTML = '<p>æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ é¢˜ç›®ã€‚</p>';
                return;
            }

            const randomIndex = Math.floor(Math.random() * fullBank.length);
            currentQuestion = fullBank[randomIndex];
            practiceAnswered = false;

            renderPracticeQuestion();
        }

        // æ¸²æŸ“è‡ªç”±ç»ƒä¹ é¢˜ç›®
        function renderPracticeQuestion() {
            const container = document.getElementById('questionContainer');
            
            if (currentQuestion.type === 'fill') {
                const blanks = (currentQuestion.question.match(/_____/g) || []).length;
                let questionHtml = currentQuestion.question;
                for (let i = 0; i < blanks; i++) {
                    questionHtml = questionHtml.replace('_____', `<input type="text" class="answer-input" data-index="${i}">`);
                }
                
                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">å¡«ç©ºé¢˜</span>
                        <div class="question-text fill-blank">${questionHtml}</div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="checkPracticeFillAnswer()">æäº¤ç­”æ¡ˆ</button>
                            <button class="btn btn-warning" onclick="markPracticeCorrect()">æ­¤é¢˜ç­”å¯¹äº†</button>
                            <button class="btn btn-secondary" onclick="loadPracticeQuestion()">ä¸‹ä¸€é¢˜</button>
                        </div>
                        <div id="practiceResult"></div>
                    </div>
                `;
            } else if (currentQuestion.type === 'choice') {
                const optionsHtml = currentQuestion.options.map((option, index) => 
                    `<label class="option" onclick="selectPracticeOption(this, '${option.charAt(0)}')">
                        <input type="radio" name="practiceChoice" value="${option.charAt(0)}" style="display:none;">
                        ${option}
                    </label>`
                ).join('');

                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">é€‰æ‹©é¢˜</span>
                        <div class="question-text">${currentQuestion.question}</div>
                        <div class="options">${optionsHtml}</div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="checkPracticeChoiceAnswer()">æäº¤ç­”æ¡ˆ</button>
                            <button class="btn btn-warning" onclick="markPracticeCorrect()">æ­¤é¢˜ç­”å¯¹äº†</button>
                            <button class="btn btn-secondary" onclick="loadPracticeQuestion()">ä¸‹ä¸€é¢˜</button>
                        </div>
                        <div id="practiceResult"></div>
                    </div>
                `;
            } else if (currentQuestion.type === 'essay') {
                container.innerHTML = `
                    <div class="question-card">
                        <span class="question-type">ç®€ç­”é¢˜</span>
                        <div class="question-text">${currentQuestion.question}</div>
                        <div class="form-group">
                            <label>ä½ çš„ç­”æ¡ˆï¼š</label>
                            <textarea id="practiceEssayAnswer" rows="6" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                        </div>
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="checkPracticeEssayAnswer()">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</button>
                            <button class="btn btn-success" onclick="markPracticeEssayCorrect()">ç­”å¯¹äº†</button>
                            <button class="btn btn-secondary" onclick="markPracticeEssayWrong()">ç­”é”™äº†</button>
                            <button class="btn btn-secondary" onclick="loadPracticeQuestion()">ä¸‹ä¸€é¢˜</button>
                        </div>
                        <div id="practiceResult"></div>
                    </div>
                `;
            }
        }

        // é€‰æ‹©è‡ªç”±ç»ƒä¹ é€‰é¡¹
        function selectPracticeOption(element, value) {
            if (practiceAnswered) return;
            
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // æ£€æŸ¥è‡ªç”±ç»ƒä¹ å¡«ç©ºé¢˜ç­”æ¡ˆ
        function checkPracticeFillAnswer() {
            if (practiceAnswered) return;
            
            const inputs = document.querySelectorAll('.answer-input');
            const userAnswers = Array.from(inputs).map(input => input.value.trim());
            const correctAnswers = currentQuestion.answer.split(';').map(ans => ans.trim());
            
            let isCorrect = true;
            if (userAnswers.length !== correctAnswers.length) {
                isCorrect = false;
            } else {
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i].toLowerCase() !== correctAnswers[i].toLowerCase()) {
                        isCorrect = false;
                        break;
                    }
                }
            }
            
            inputs.forEach((input, index) => {
                if (index < correctAnswers.length) {
                    const userAns = input.value.trim().toLowerCase();
                    const correctAns = correctAnswers[index].toLowerCase();
                    input.classList.add(userAns === correctAns ? 'correct' : 'wrong');
                }
            });
            
            showPracticeResult(isCorrect, `æ­£ç¡®ç­”æ¡ˆï¼š${correctAnswers.join(' ; ')}`);
            updatePracticeStats(isCorrect);
        }

        // æ£€æŸ¥è‡ªç”±ç»ƒä¹ é€‰æ‹©é¢˜ç­”æ¡ˆ
        function checkPracticeChoiceAnswer() {
            if (practiceAnswered) return;
            
            const selectedOption = document.querySelector('input[name="practiceChoice"]:checked');
            if (!selectedOption) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                return;
            }
            
            const userAnswer = selectedOption.value;
            const isCorrect = userAnswer === currentQuestion.answer;
            
            document.querySelectorAll('.option').forEach(option => {
                const optionValue = option.querySelector('input').value;
                if (optionValue === currentQuestion.answer) {
                    option.classList.add('correct');
                } else if (optionValue === userAnswer && !isCorrect) {
                    option.classList.add('wrong');
                }
            });
            
            showPracticeResult(isCorrect, `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${currentQuestion.answer}`);
            updatePracticeStats(isCorrect);
        }

        // æ£€æŸ¥è‡ªç”±ç»ƒä¹ ç®€ç­”é¢˜ç­”æ¡ˆ
        function checkPracticeEssayAnswer() {
            const userAnswer = document.getElementById('practiceEssayAnswer').value.trim();
            
            if (!userAnswer) {
                alert('è¯·å…ˆè¾“å…¥ä½ çš„ç­”æ¡ˆ');
                return;
            }
            
            const similarity = calculateSimilarity(userAnswer, currentQuestion.answer);
            
            const resultHtml = `
                <div class="result info">
                    <h4>å‚è€ƒç­”æ¡ˆï¼š</h4>
                    <p>${currentQuestion.answer}</p>
                    <div class="similarity-score">
                        <strong>ä¸å‚è€ƒç­”æ¡ˆç›¸ä¼¼åº¦ï¼š${similarity.toFixed(1)}%</strong>
                        <br><small>ç›¸ä¼¼åº¦è¶Šé«˜è¯´æ˜ç­”æ¡ˆè¶Šæ¥è¿‘å‚è€ƒç­”æ¡ˆ</small>
                    </div>
                    <p style="margin-top: 10px;"><strong>è¯·æ ¹æ®å‚è€ƒç­”æ¡ˆè‡ªè¡Œåˆ¤æ–­ä½ çš„å›ç­”æ˜¯å¦æ­£ç¡®</strong></p>
                </div>
            `;
            
            document.getElementById('practiceResult').innerHTML = resultHtml;
        }

        // æ ‡è®°è‡ªç”±ç»ƒä¹ é¢˜ç›®æ­£ç¡®
        function markPracticeCorrect() {
            updatePracticeStats(true);
            showPracticeResult(true, 'å·²æ ‡è®°ä¸ºæ­£ç¡®ç­”æ¡ˆ');
        }

        // æ ‡è®°è‡ªç”±ç»ƒä¹ ç®€ç­”é¢˜æ­£ç¡®
        function markPracticeEssayCorrect() {
            updatePracticeStats(true);
            showPracticeResult(true, 'å·²æ ‡è®°ä¸ºæ­£ç¡®ç­”æ¡ˆ');
        }

        // æ ‡è®°è‡ªç”±ç»ƒä¹ ç®€ç­”é¢˜é”™è¯¯
        function markPracticeEssayWrong() {
            updatePracticeStats(false);
            showPracticeResult(false, 'å·²æ ‡è®°ä¸ºé”™è¯¯ç­”æ¡ˆ');
        }

        // æ˜¾ç¤ºè‡ªç”±ç»ƒä¹ ç»“æœ
        function showPracticeResult(isCorrect, message) {
            practiceAnswered = true;
            const resultDiv = document.getElementById('practiceResult');
            resultDiv.className = `result ${isCorrect ? 'correct' : 'wrong'}`;
            resultDiv.innerHTML = isCorrect ? 
                'âœ… å›ç­”æ­£ç¡®ï¼' : 
                `âŒ å›ç­”é”™è¯¯ï¼<br>${message}`;
        }

        // æ›´æ–°è‡ªç”±ç»ƒä¹ ç»Ÿè®¡
        function updatePracticeStats(isCorrect) {
            stats.practiceStats.totalAnswered++;
            if (isCorrect) {
                stats.practiceStats.correctAnswers++;
                stats.currentStreak++;
                stats.bestStreak = Math.max(stats.bestStreak, stats.currentStreak);
            } else {
                stats.currentStreak = 0;
            }
            updateStats();
            saveStats();
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            const fullBank = getFullQuestionBank();
            document.getElementById('totalQuestions').textContent = fullBank.length;
            document.getElementById('correctCount').textContent = stats.practiceStats.correctAnswers;
            document.getElementById('wrongCount').textContent = stats.practiceStats.totalAnswered - stats.practiceStats.correctAnswers;
            
            const practiceAccuracy = stats.practiceStats.totalAnswered > 0 ? 
                Math.round((stats.practiceStats.correctAnswers / stats.practiceStats.totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = practiceAccuracy + '%';
            
            // ç»Ÿè®¡é¡µé¢
            document.getElementById('totalExams').textContent = stats.totalExams;
            const overallAccuracy = stats.totalQuestions > 0 ? 
                Math.round((stats.totalCorrectAnswers / stats.totalQuestions) * 100) : 0;
            document.getElementById('avgAccuracy').textContent = overallAccuracy + '%';
            document.getElementById('bestStreak').textContent = stats.bestStreak;
            
            const studyTime = Math.round((Date.now() - stats.studyStartTime) / 60000);
            document.getElementById('studyTime').textContent = studyTime;
        }

        // åˆ‡æ¢é€‰é¡¹è¾“å…¥æ˜¾ç¤º
        function toggleOptions() {
            const type = document.getElementById('questionType').value;
            const optionInputs = document.getElementById('optionInputs');
            
            if (type === 'choice') {
                optionInputs.classList.add('show');
            } else {
                optionInputs.classList.remove('show');
            }
        }

        // æ·»åŠ é¢˜ç›®
        function addQuestion() {
            const type = document.getElementById('questionType').value;
            const questionText = document.getElementById('questionText').value.trim();
            const correctAnswer = document.getElementById('correctAnswer').value.trim();
            
            if (!questionText || !correctAnswer) {
                alert('è¯·å¡«å†™é¢˜ç›®å†…å®¹å’Œæ­£ç¡®ç­”æ¡ˆ');
                return;
            }
            
            const newQuestion = {
                type: type,
                question: questionText,
                answer: correctAnswer,
                category: 'è‡ªå®šä¹‰'
            };
            
            if (type === 'choice') {
                const optionA = document.getElementById('optionA').value.trim();
                const optionB = document.getElementById('optionB').value.trim();
                const optionC = document.getElementById('optionC').value.trim();
                const optionD = document.getElementById('optionD').value.trim();
                
                if (!optionA || !optionB || !optionC || !optionD) {
                    alert('è¯·å¡«å†™æ‰€æœ‰é€‰é¡¹');
                    return;
                }
                
                newQuestion.options = [
                    'A. ' + optionA,
                    'B. ' + optionB,
                    'C. ' + optionC,
                    'D. ' + optionD
                ];
            }
            
            customQuestionBank.push(newQuestion);
            saveCustomQuestions();
            updateQuestionBank();
            updateStats();
            clearForm();
            alert('é¢˜ç›®æ·»åŠ æˆåŠŸï¼');
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('correctAnswer').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';
        }

        // æ›´æ–°é¢˜åº“æ˜¾ç¤º
        function updateQuestionBank() {
            const container = document.getElementById('questionBank');
            const fullBank = getFullQuestionBank();
            
            if (fullBank.length === 0) {
                container.innerHTML = '<p>æš‚æ— é¢˜ç›®</p>';
                return;
            }
            
            const html = fullBank.map((q, index) => {
                const isCustom = index >= builtInQuestionBank.length;
                const deleteButton = isCustom ? 
                    `<button class="btn btn-secondary" onclick="deleteQuestion(${index - builtInQuestionBank.length})">åˆ é™¤</button>` : 
                    '<span style="color: #666;">(å†…ç½®é¢˜ç›®)</span>';
                
                return `
                    <div class="question-card">
                        <span class="question-type">${q.type === 'fill' ? 'å¡«ç©ºé¢˜' : q.type === 'choice' ? 'é€‰æ‹©é¢˜' : 'ç®€ç­”é¢˜'}</span>
                        <div class="question-text">${q.question}</div>
                        <div style="margin-top: 10px;">
                            <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${q.answer}
                        </div>
                        ${q.options ? `<div style="margin-top: 10px;"><strong>é€‰é¡¹ï¼š</strong><br>${q.options.join('<br>')}</div>` : ''}
                        <div style="margin-top: 10px;">
                            ${deleteButton}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // åˆ é™¤è‡ªå®šä¹‰é¢˜ç›®
        function deleteQuestion(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) {
                customQuestionBank.splice(index, 1);
                saveCustomQuestions();
                updateQuestionBank();
                updateStats();
            }
        }

        // ä¿å­˜ç»Ÿè®¡æ•°æ®
        function saveStats() {
            localStorage.setItem('bioreactorStats', JSON.stringify(stats));
        }

        // ä¿å­˜è‡ªå®šä¹‰é¢˜ç›®
        function saveCustomQuestions() {
            localStorage.setItem('customQuestionBank', JSON.stringify(customQuestionBank));
        }

        // åŠ è½½å­˜å‚¨çš„æ•°æ®
        function loadStoredData() {
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            const storedStats = localStorage.getItem('bioreactorStats');
            if (storedStats) {
                const parsedStats = JSON.parse(storedStats);
                stats = {...stats, ...parsedStats};
            }
            
            // åŠ è½½è‡ªå®šä¹‰é¢˜ç›®
            const storedQuestions = localStorage.getItem('customQuestionBank');
            if (storedQuestions) {
                customQuestionBank = JSON.parse(storedQuestions);
            }
        }

        // æ¸…é›¶å­¦ä¹ ç»Ÿè®¡
        function clearStats() {
            if (confirm('ç¡®å®šè¦æ¸…é›¶æ‰€æœ‰å­¦ä¹ ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå°†æ¸…é›¶ä»¥ä¸‹æ•°æ®ï¼š\nâ€¢ è€ƒè¯•æ¬¡æ•°\nâ€¢ å¹³å‡æ­£ç¡®ç‡\nâ€¢ æœ€é•¿è¿å¯¹è®°å½•\nâ€¢ å­¦ä¹ æ—¶é•¿\nâ€¢ è‡ªç”±ç»ƒä¹ è®°å½•')) {
                stats = {
                    totalExams: 0,
                    totalCorrectAnswers: 0,
                    totalQuestions: 0,
                    currentStreak: 0,
                    bestStreak: 0,
                    studyStartTime: Date.now(),
                    practiceStats: {
                        totalAnswered: 0,
                        correctAnswers: 0
                    }
                };
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç»Ÿè®¡æ•°æ®
                localStorage.removeItem('bioreactorStats');
                
                // æ›´æ–°æ˜¾ç¤º
                updateStats();
                
                alert('å­¦ä¹ ç»Ÿè®¡æ•°æ®å·²æ¸…é›¶ï¼');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>